# モニタリング入門

### モニタリングの用途
- 開発
  - 性能測定
  - デバッグ
  - ユーザーの利用状況に応じた機能改善
- 運用
  - 問題検出　→　アラート
  - オートスケーリング
  - デプロイ自動化
- ビジネス
  - ユーザーの利用状況を分析　→　ビジネスの意思決定に利用

**監視とは**
役割ではなくスキル

---

###　モニタリングシステムの仕組み
- モニタリングの基本
  - 収集
    - アプリケーションやサーバーからメトリクスを集める
  - 蓄積
    - 集めたメトリクスを保存する
  - 分析
    - 保存したメトリクスから必要な情報を取り出す
  - 可視化
    - 取り出した情報を表示する
  - アラート
    - 取り出した情報に基づいて通知

<br>

- 用語
  - メトリクス
    - 活動を定量化して得たデータを加工したもの

<br>

**モニタリングシステム**
- VictoriaMetrics
  - 高速でコスト効率がよくスケーラブルなモニタリングシステム
  - 時系列データベース
  - データの圧縮効率がよく長期保存ができる
  - Prometheusの完全互換
- Prometheus

<br>

**VictoriaMetrics Operator**
- VictoriaMetrics関連のコンポーネントのデプロイを自動化してくれるソフトウェア
- カスタムリソース（YAMLファイル）を用意するだけでメトリクスの収集エージェントやアラートマネージャーなどをデプロイ可能
- メトリクスの収集ルールや、アラートルールもカスタムリソースで記述可能

<br>

**主要コンポーネント**
- VMAgent
  - メトリクスの収集
- VMStorage
  - メトリクスの蓄積
- Grafana
  - メトリクスの可視化ツール
- VMAlert
  - アラートの判断
- AlertManager
  - アラートの送信

<br>

**基本メトリクス収集のコンポーネント**
- cAdvisor
  - コンテナごとのCPUやメモリ、I/Oの使用量などのメトリクスを収集
- kube-state-metrics
  - PodやDevelopment、Service等のリソースのメトリクスを収集
- Node exporter
  - ハードウェアやOSからメトリクスを収集

<br>

**メトリクスのタイプ**
- Counter
  - 増加する値を示す
    - 例：
      - APIリクエスト数の累計
      - パケットの合計受信サイズ
- Gauge
  - 現在の値を示す
    - 例：
      - ディスクの使用量
      - CPU使用率
- Summary
  - 観測値の集計結果
    - 例：
      - HTTPリクエストのサイズ
      - リクエストのレイテンシー
- Histogram
  - 観測値の集計データ
    - 例：
      - HTTPリクエストのサイズ
      - リクエストのレイテンシー

<br>

**メトリクスの蓄積**

> アプリケーション　↔　VMAgent　→　VMStorage

- アプリケーション
  - 現在のメトリクスのみを出力
- VMAgent
  - アプリケーションから30秒周期でデータを取得
  - 取得したデータにラベルを付与
- VMStorage
  - VMAgentから送られてきたデータを保存
  - 送られてきたデータにTimestampを付与して時系列データとして保存

---

### PromQL
- PromQL
  - 時系列データを取得・集計するためのクエリ言語
  - 利用用途
    - メトリクスを集計してパフォーマンスの分析
    - 収集したメトリクスを可視化
    - 特定の条件にマッチした時にアラートを発行

<br>

**instanceとjobラベル**
- どのメトリクスにも必ず存在するラベル
- instance
  - メトリクスを収集したエンドポイントを示す
  - 例：
    - アプリケーションが動いているサーバーのIPアドレス
- job
  - 同じ目的を持つインスタンスの集合を示す
  - 例：
    - アプリケーションの名前

<br>

**SummatyとHistogram**
- 分位数（パーセンタイル）を扱うためのメトリクスタイプ
- Summaryは分位数そのものをメトリクスとして出力
- Histgramは後から分位数を計算できるように、3種類の値をメトリクスとして出力
  - xxx_count
    - データの全数
  - xxx_sum
    - 全データの値の合計
  - xxx_bucket{le="n"}
    - n以下の値のデータ数

---

### 別途調査

**モニタリングの重要性**

- システム障害の監視とアラート
  - 気づくのが早くなる　＝　早期の対応が可能に
- CPU使用率、メモリリソースの使いすぎをアラート
  - リソース不足でサーバーダウンなどを未然に防げる
- システムの安定運用　＝　信用
  - 信用を守るためにも必要

#### AWS利用の場合はAWS CloudWatch等がある

**Grafanaとは**
- Grafana Labs社が開発したデータ可視化ツール
  - 元のデータが必要になるため、データ集積ツールが別途必要
    - 例：
      - Prometheus
      - Elasticsearch
      - etc...

<br>

- Grafanaの主な特徴
  - 可視化
    - 多数のオプション有り
    - 高速で柔軟なグラフ作成
    - メトリクスやログを可視化するパネルプラグインが備わる
  - 動的なダッシュボード
    - 可視化結果を一覧で表示させるダッシュボード
    - テンプレート変数を利用すると、動的で再利用可能なものになる
  - Metricsの探索
    - アドホックなクエリとダイナミックなドリルダウンを使用してデータを探索
    - ビューを分割し、異なる時間範囲、クエリ、データソースを並べて比較可能
  - ログの探索
    - 全てのログの高速検索
    - ライブストリーミングが可能
    - Grafana Lokiで収集したログをデータソースとして利用すると親和性が高い
  - アラート
    - 重要なメトリクスのアラートルールを視覚的に定義可能
    - 外部システムに通知を送ることも可能
  - 複数のデータソースの利用
    - クエリ、カスタムデータソースを利用すると、同じグラフで異なる複数のデータソースを合わせられる
  - アノテーション
    - 異なるデータソースからの豊富なイベントに対して、アノテーションを付与できる
  - アドホックフィルター
    - 新しいキューやバリューフィルターをその場で適用可能
    - 自動的に全てのクエリに適用できる
# CI / CD

学習者：m.sasaki

### CI / CDがない開発
- 各自の環境で開発
  - リリース前に各自の変更を結合してテスト
    - 修正依頼　→　原因の特定が難しい
    - 修正後も新しい不具合が発生し、以下ループ

- 問題点
  1. 結合のタイミングでまとめて大きな差分が発生
     - 壊れやすい、原因究明が困難
  2. 変更してから問題が見つかるまでのタイムラグが大きい
     - 学習が遅れるのでその間に類似不具合が埋め込まれる
  3. リスク（不確実性）が高い
     - 結合後の対応がどれくらいになるのか予測しづらい

---

### CI (Continuous Integration)

- CIとは
  - 開発プラクティス
  - 1日に何回もバージョン管理システムに変更をマージする
  - 毎回テストなどを含む自動ビルドが実行される

<br>

#### CIがある開発
- 開発者が「master」ブランチから「Task」ブランチを作成
  - ローカル環境でコード変更
    - 「Task」ブランチにプッシュしてPR（プルリクエスト）を作成
      - CIツールが「Task」ブランチのコードでビルドを実行
        - ビルドが失敗したら通るまで「修正」＆「CI再実行」
          - ビルドが成功したら「master」ブランチにマージ
            - CIツールが「master」ブランチでビルド実行
              - ビルドが失敗したら通るまで修正

<br>

- CIの利点
  - 高速なフィードバック
    - 問題の早期発見
    - 高速な学習
  - 頻繁に変更がマージされるようになれば差分が大きくならない
    - 問題発見時の調査が簡単になる
    - リスク（不確実性が減る）
  - Success / Failの可視化によるコミュニケーションの促進
  - 毎回の変更が自動テストで保証される安心感

---

### CD (Continuous Delivery)
- CDとは
  - CIの発展型
    - コードの変更がトリガーとなって実行されるのはCIと同様
  - コード変更からリリースまでに必要な検証を行う
    - 常に信頼できるリリースができる状態を保つ
  - デプロイパイプラインという形で自動化する
    - 部分的に手動作業が入ることがある

<br>

- CDの利点
  - リリースのコストやリスクを抑えられる
    - いつでもリリースできる
  - コード変更からリリースまでのフローが可視化される
    - どこで問題が起きているか、どこがボトルネックかが、すぐに分かる

<br>

#### CI / CD内で実行すること
- 静的解析
  - 構文チェック
    - 構文エラーを防ぐ
  - コードスタイルチェック
    - 可読性を高める、本質的でない議論を防ぐ
  - コードパターチェック
    - エラーが発生しやすいパターンを防ぐ

<br>

- 自動テスト
  - 単体テスト
    - 小さい単位のコードが役割どおり動作するかチェック
  - 結合テスト
    - 複数コードを組み合わせた機能が正しく動作するかチェック
  - 受け入れテスト（E2E テスト）
    - ビジネス要求を満たしているかチェック
  - 上記以外にも色々
    - テストの種類ごとの呼び方や目的はチームによって異なるので、認識合わせが重要

<br>

- 非機能要件のテスト
  - 性能検証、脆弱性検証等
  - CI / CDにどのように組み込むかは時と場合による
    - 毎回実行するには処理時間が長くなりやすい
    - 組み込めるなら組み込んだほうがいい

<br>

- アーカイブ作成
  - デプロイ・リリース時に使用するアーカイブ
  - 結合テスト、E2Eテスト、非機能要件テストでも使用する
    - テストに通ったアーカイブをリリース

<br>

- デプロイ・リリース
  - 「master」ブランチにマージされたときだけに実行されることが多い
    - 「Task」ブランチでも動作確認用環境にデプロイなどはあり得る
  - ステージング環境
    - 本番環境によく似せたステージング環境でまずはデプロイ
  - 本番環境へのリリース戦略
    - 万一の問題発生に備えることが重要
      - 一部の環境から広げていく、ロールバック、無停止
      - カナリアリリース、ブルーグリーンデプロイ、フィーチャーフラグ etc...

### CI / CDツール
- Jenkins
  - OSS
  - オンプレ構築できる
  - コミュニティが大きいのでプラグインが豊富
  - 柔軟でやろうと思えば何でもできる

<br>

- CircleCI
  - クラウドサービス
    - オンプレ版もある
  - シンプルで導入しやすい
  - 認証とか権限とかGitHubと連携していて導入が楽

<br>

- GitHub Actions
  - GitHubが提供するCi / CDサービス
  - パブリックリポジトリでは完全無料
  - CI / CDに限らずGitHubの様々なイベントにフックできる

<br>

- AWS Codeシリーズ
  - CodeBuild、CodeDeploy、CodePipeline、etc...
  - AWSと権限周りを統合しやすい

<br>

- Kubernetes用CDツール
  - Argo CDなど
  - GitOpsと呼ばれる手法がよく使われている

---

### CI / CD導入
- 新規開発への導入
  - 最初からCI / CDを導入するのがおすすめ
  - 後回しにすると自動化しづらい作りになりやすい

<br>

- 既存開発へ途中から導入
  - レガシーな部分が原因で難易度が上がりやすい
  - 手を付けやすく効果の高そうな所から始めるのがおすすめ
    - ビジネス的に重要な部分の正常系テスト等
  - いきなり長時間かかるジョブを構築するのはおすすめしない

<br>

#### CI / CDは一気に導入せずにコスパの良さそうなところから
> **重要**
> - チームでの認識合わせ
> - 継続的な改善

---

### アンチパターンとベストプラクティス
- ローカルで長時間開発
  - 変更差分が大きくなる
    - 他の開発者の変更と衝突しやすい
    - 壊れやすい
    - 原因究明が困難
  - 変更してから問題が見つかるまでのタイムラグが大きくなる
    - 問題に気づくのが遅れるほど対応コストは大きくなる

> **頻繁に変更をバージョン管理システムにコミットする**
>  - 目安は全員が1日1回以上
>  - コミットが大きくなりすぎないように意味単位で分割
>    - 問題発見やレビューが簡単に
>  - タスクも粒度が小さくなるように分割したほうが不確実性を減らせる

<br>

- ビルドの実行頻度が低い
  - 1日に1回しか実行されないケース
  - ビルド失敗時にどの変更が原因かわかりにくい
  - 変更してから問題が見つかるまでのタイムラグが大きくなる
    - 問題に気づくのが遅れる　→　対応コスト大

> **全てのコミットでビルドを実行する**
> - ビルドが失敗したときは直前のコミットが原因の可能性が高くなる（調査しやすい）
> - フィードバックが早い（対応コストが小さくなる）

#### ビルドが失敗していたらチームは最優先で復旧する

<br>

- CI / CDのビルド時間が長すぎる
  - 結合テストや受け入れテストを厚くしすぎるとなりやすい
  - 1時間以上になってくると厳しい
    - 失敗時に再実行することとを考えると厳しい

> **CI /CDを高速に保つ**
> - 可能な限り並列実行する
> - 自動テストの役割を継続的に見直す（テストピラミッドを意識）

<br>

- テストピラミッドのポイント
  - 色々な粒度のテストを組み合わせる
  - 粒度が大きくなるほど実行時間やメンテナンスコストが高くなる
  - より小さい粒度のテストで防げるものは防ぐ

<br>

- 不安定なビルド
  - 不具合ではないのにビルドが失敗する
    - CI / CDの信頼性が下がる
  - 原因は色々
    - 本番コードではないので手抜きスクリプトが書かれている
    - E2Eテストの微妙なタイミングのズレ
    - 不安定な環境
      - 構築手順が微妙に異なる、前のビルドのゴミが残っているなど

> **ビルドを継続的に改善して品質を高める**
> - ビルドで実行されるタスクは製品コードレベルの品質を目指す
> （特にメンテナンス性を高めることが重要）
> - ビルド結果を予測する
> （ビルド失敗頻度やその原因を振り返れるようにすると改善しやすい）
> - 防ぎづらいレアケースもあるので自動リトライも1つの手段
> - 環境は仮想化して毎回クリーンにする
> （Dockerコンテナ内でビルドするのが最近は一般的）

#### CIを実践するために必要な環境
1. コードを統合する為の共有リポジトリの用意
2. コードが正しく動くか検証する実行可能なテストコード
3. テストコードを自動実行できる環境（CI環境）

#### CDを実践するために必要な環境
1. コードのリリースやデプロイをする実行可能なコード
2. リリースやデプロイをするコードを自動実行できる環境（CD環境）

#### CI / CDの進め方　例
1. 共有リポジトリ環境の整備
2. CI環境の整備
3. 共有リポジトリにコードが登録されたら、自動でテストコードが実行されるようにする
4. ソフトウェアのコードとテストコードを書く
5. リリースやデプロイのコードを書く
6. CD環境の整備

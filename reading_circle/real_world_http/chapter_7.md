# HTTP/2、HTTP/3のシンタックス:プロトコルの再定義

担当: @m.Sasaki

## 7.1 HTTP/2、HTTP/3で変わらないこと
- Webサイトがリッチになっていき、ファイル数やサイズが増えていく中で、より高速な転送の仕組みが求められた
  - HTTP/2、HTTP/3はHTTP/1.1から大きな飛躍を遂げる（16年もの間、HTTP/1.1が最新で有り続けた）
- HTTP/1.1までと変わらないこと
  - 今まで書籍で読んできたHTTPの提供する4つの基本要素
    - メソッド
    - ヘッダー
    - ステータス
    - ボディ

> - 新しいプロトコルが出てきたからと言ってそれ以前のものが不要になることはない
>   - 例：
>     - TCPしか使えない環境で最速を求める場合: HTTP/2
>     - 複数のマイクロサービスを連携させる場合: HTTP/1.1

---

## 7.2 HTTP/2
- 変わったこと
  - バイナリデータでの通信を行う
    - HTTP/1.1ではテキストベースの通信を行っている
  - TLSが必須（利用していない場合HTTP/1.1を利用）
    - TLSの利用なしでも使用することは可能だが、主要なブラウザはTLSを使用しない接続は未対応となっている
  - ストリームという仕組みによる複数のリクエスト/レスポンスの処理が可能に
  - HTTPヘッダー情報の圧縮
    - HTTP/1.1ではリクエスト毎にヘッダーを付与していたが、ヘッダーの重複する項目を効率圧縮（HPACK圧縮）するようになった

---

## 7.2.1 SPDY(スピーディー)
- HTTP/2の元となるプロトコル
  - Googleによって開発された物でこれがほぼそのままHTTP/2となる
- 開発された目的
  - Web表示の待ち時間短縮を目的とした
  - RTT（Round Trip Time 別名: 往復レイテンシ）の値を小さくすることでページダウンロードの時間を短縮させる
    - RTT: データパケットが宛先に送信されるのにかかる時間と、送信されたパケットの確認応答が発信元で受信されるのに掛かる時間の長さ
  - 回線帯域の改善も調査したようだが、回線帯域がいくら改善されてもRTTが大きいと速度は落ちることからHTTP/2ではRTTに着目し改善

> - [参考サイト:Web表示の高速化を実現するSPDYとHTTP/2.0の標準化](https://www.iij.ad.jp/dev/tech/activities/spdy/)
> - [Round Trip Time(RTT)](https://developer.mozilla.org/ja/docs/Glossary/Round_Trip_Time_(RTT))

## 7.2.2 HTTP/2の改善点
- ストリームを使用してバイナリデータを多重送受信する仕組みに変更
  - ストリーム: 1つのTCPコネクション上での仮想的な経路のようなもの(複数生成が可能)
  - フレーム: 1つのHTTPメッセージ（ストリームID、リクエストやレスポンス、ヘッダー情報など）を複数のバイナリ構造に分解したもの
- ストリーム内での優先順位設定や、サーバーサイドからデータの通信を行うサーバー（サイド）プッシュを実装
  - サーバー（サイド）プッシュ: サーバー側で必要なファイルを判別して事前にクライアントに送信する
  - 優先順位の注意点
    - サーバーの実装に依存する部分が大きい
    - あくまでお願いベースでの優先度の指定のため、必ず優先度が守られるわけではない
- ヘッダーの圧縮
- 計算機速度の向上によって短期間解読ができるようになった暗号スイートの非推奨化
- ALPN（Application-Layer Protocol Negotiation　本書P125,P133で紹介）を使用して通信方式を切り替える
  - HTTP/1.1とは完全に異なっているため、後方互換性の問題が起きにくくなっている
    - トランスポート層で通信方式を切り替える形で、クライアントとサーバーが受け取る形式はHTTP/1.1と変わりがないためと考えた
  - 参考サイト:[HTTP/2 プロトコルネゴシエーション方法と ATS での実装](https://techblog.yahoo.co.jp/infrastructure/http2/ats_http2_pn/)

---

## 7.2.3 ストリームによる通信の高速化
- HTTP/1.1では1リクエストで1つのTCPソケットを専有してしまっていた
  - 1つのオリジンサーバーで最大で6つのTCP接続を行って処理を行う
- HTTP/2では1つのTCP接続で、その内部にストリームというパイプ（経路）を作る
  - リクエストやヘッダー情報などを、フレームと呼ばれる単位に分解したものを送受信する
  - 簡単に多くの並列処理を行うことが可能になった

- TCP
  - クローズ状態　→　LISTEN　→　接続リクエスト　→　ESTABLISH（通信可能）状態になる
- ストリーム
  - IDLE状態（LISTENとほぼ同じ）　→　ヘッダー受信　→　ESTABLISH（通信可能）状態になる

- Stream Identifier
  - 擬似的なソケットとして作られたストリームを識別するヘッダー情報（ストリーム識別子）
  - 符号なし、31ビット整数として表す
  - 識別子の値
    - 0: 予約されていて使うとエラーが起きる
      - コネクション制御メッセージに使用される
    - 奇数: クライアントからサーバー
    - 偶数: サーバーからクライアント
- フレームの種類は書籍を参照
  - 後方互換性のない機能はSETTINGSフレームを使用して行うことが可能
  - オプションとなっているのは指定しなければ省略されヘッダーサイズを抑えられるため
  - 2016年から2020年までの間で追加されたものはSETTINGS値1つだけ
    - 小さい拡張は繰り返されていく
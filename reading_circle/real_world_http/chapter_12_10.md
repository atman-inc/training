# 12章 ウェブアプリケーションの基礎

@y-kaneda

## 12.10 今後はあまり使われなくなる技術

### 12.10.1 CGI (Common Gateway Interface)
- 標準入出力と環境変数が使える任意の言語で自由に動的なWebサービスを作るための規格
- HTTPリクエストの受け取りはApacheなどのサーバーが行い、CGIにデータを分解して受け渡す
- HTMLのテキストを生成するものが多かったが、`<img src="http://example.com/sample.cgi">`のようにして画像を生成して表示させることもできた
- リクエストを受けるたびにプロセスを起動し処理が終われば終了するという処理の重さがデメリット
- プロセスを起動しっぱなしにしてソケット通信でやりとりするFastCGIが考案され、こちらは今でもPHPを利用する方法で現役

### 12.10.2 リッチ・インターネット・アプリケーション
- 単純なWebページを表示するだけでなく、表現力の高いユーザインターフェース
  - Javaアプレット
  - Flash
  - JavaFX
  - Microsoft Silverlight
- ブラウザのプラグインとして動作し、当時はJavaScriptより実装がしやすい別言語でリッチなコンテンツを開発していた
- Flashのシェアが一番高く、ブラウザゲームや動画再生機能等、多くのサイトで提供されていた
- JavaScript の動作・開発環境が整ってくるとFlashの欠点が目立ってきた
  - プラグインのインストールが必須
  - 検索エンジンとの相性
  - セキュリティ上の懸念
  - アクセシビリティを意識したUIとの相性
  - 消費電力の大きさ

# 13章 クラウド時代のHTTP：ウェブを強くするさまざまな技術

## 13.1 より大規模なウェブシステムの構成
- 1台のサーバーのみでアプリケーションを動作させるデメリット
  - ユーザー数が多くなった場合に処理能力が足りなくなる
  - 障害が発生すると全てのサービスが止まる
- ロードバランサー
  - 同時に接続できるリクエスト数を増やす
  - 文字通り負荷（ロード）を分散（バランス）させる
  - クラウドサービスで提供されているロードバランサー
    - ソフトウェアの設定で簡単にネットワークのやサーバー数の設定等が柔軟にできる
    - オートスケール機能がついており、負荷の大きさに対してサーバーを増減させられる
- クラウドサービスで可用性の向上に寄与できる点
  - リージョン
    - 東京、シンガポール、アメリカ西海岸・東海岸 等データセンターの物理的な位置が分散している
  - アベイラビリティゾーン(AZ)
    - それぞれのリージョン内でさらにラックや電源等が物理的に独立している

## 13.2 DNS(Domain Name Service)
- ドメイン名から実際のIPアドレスを取得する機能

### 13.2.1 DNSの事前問い合わせ
- HTTPの通信が開始する前には既にDNSの問い合わせが完了しているはず
- 例えば返ってきたHTMLから外部ドメインのリソースを参照している場合、さらに追加でドメイン解決が必要になる
  - HTMLファイルに外部のCSSとウェブフォントが使われているケース
    1. ウェブサイトのDNSの問い合わせ
    2. HTMLファイルをリクエスト
    3. HTMLファイルに書かれているCSSをリクエスト
    4. CSSに書かれているウェブフォントが置いてあるドメインのDNSの問い合わせ
    5. ウェブフォントをリクエスト
- 最初のHTTPレスポンスの際に利用されうるドメインの名前を通知することで、CSSの問い合わせ時に並行でウェブフォントの問い合わせができる
- HTTP/2 では `preconnect` で事前にDNS問い合わせ、TCP、TLSのハンドシェイクまで一括で行う(7.2.7)

### 13.2.2 DNSサーバーのキャッシュ
- ドメイン名に紐づくIPアドレスはそう頻繁に変わることはないため、キャッシュが高速化に有効
- DNSキャッシュサーバーが権威サーバー(実際のドメインとIPアドレスの対応表を持っている)からの問い合わせ結果をキャッシュする
- jp -> co -> 企業ドメイン 等、上位から順番に権威サーバーに問い合わせていく
- キャッシュなので寿命があり、TTL (Time to Live)として上位サーバーに設定される
- キャッシュが生存している限り同じIPアドレスにアクセスされるため、ドメインのIPアドレスを変更したい場合は変更前にTTLを短く設定しておき、キャッシュがすぐに書き換わるようにする
- ref. https://www.nic.ad.jp/ja/newsletter/No51/0800.html

### 13.2.3 DNSクライアントのキャッシュ
- ブラウザも短期間だけDNSの結果をキャッシュしている
  - Firefox, Chrome ともに1分程度
- Keep-Alive でコネクションを維持しているので通常はDNSの再リクエストは発生しないが、少し遅れて非同期通信をしたり、追加コンテンツの取得等で効果がある
- プログラミング言語のライブラリでもキャッシュを行うものがある
  - Java OpenJDK 11 => デフォルトで失敗時に10秒間、成功時でセキュリティーマネージャーインストールされている場合は無制限、インストールされていない場合は実装次第
  - Go はデフォルトではキャッシュしないがメルカリが net/http クライアント用のOSSパッケージを提供している
- Kubernetes のDNSの挙動が不安定であるため、速度目的ではなく安定化目的でキャッシュを導入する事例もある

### 13.2.4 DNSを使ったロードバランス
- DNSラウンドロビン
  - ドメイン名とIPアドレスの対応付けはDNSの「Aレコード」という場所に入っている
  - Aレコードを複数設定し、1つのドメイン名に対して複数のIPアドレスを割り当てることも可能
  - これによりアクセスのたびに返されるIPアドレスが変化するため、IPアドレスの異なる複数のサーバーにアクセスが分散できる
  - この方法は標準的なDNSの仕様だけで実現可能
- AWS Route53
  - DNSラウンドロビン機能に加え、生存しているホストのみを返したり振り分けのルールを設定することができる
- Elastic Load Balancer(ELB)
  - AZ間のロードバランスとしてDNSを利用し、細かい制御は講談のミドルウェアで行う

### 13.2.5 DNSを使ったトラフィックの誘導
- CNAME(canonical name)レコード
  - 他の権威サーバーにDNSリクエストを委譲できる
  - ホスト名に別名を付けるためのもの
  - CDNで利用されており、クライアントにCDNサービスのDNSへリクエストさせることにより最寄りのキャッシュサーバーのIPアドレスを返すなどができる

### 13.2.6 SRVレコードを使ったサービスディスカバリー
- サービスディスカバリー
  - 特定の機能を持ったサービスを探し出す機能
    - ファインダーやエクスプローラで同一ネットワークいるコンピューターが表示される
    - 同一ネットワーク内のChromecastやスマートホーム関連のデバイスの自動検知
- SRVレコード
  - DNSで利用できるサービスディスカバリーに使えるレコード
  - DNSはホスト名からIPアドレスを探すときに利用するが、SRVレコードはサービスの種別からホスト名を探すのに利用される
  - 同じクエリ名(<サービス種別>.<プロトコル>.<ドメイン名>)の中で、優先度と重みづけでどのサービスが利用されるかが決定される
  - AWSのAmazon Elastic Container Service（ECS）はこのレコードを使ったサービスディスカバリー機能を提供している
- このレコードはクライアントOSではよく利用されており、Appleの作成したBonjourの実装方式がデファクトスタンダードになっている
  - LinuxやBSD系OS、Windowsでも導入されている

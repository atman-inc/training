# 5.3.1 から

@y-kaneda

### 5.3.1 XMLHttpRequestの誕生
- 元々はクライアントアプリ無しでブラウザで電子メールを使えるようにする機能のために原型が開発された(Alex Hopmann氏)
- Internet Explorer に搭載するために、堅牢なコンポーネントとして1から実装し直した(Shawn Bracewell氏)
- 無理矢理リリースに間に合わせるためにWindows用のXML処理ライブラリ「MSXML」に混ぜ込むことにした
  - このため、出荷するための言い訳として名前に"XML"が付き、「XMLHttpRequest」となった
- 最小化した iframe でコンテンツを読み込み JavaScript からロードして似たようなことを実現させてた人もいた

### 5.3.2 XMLHttpRequestとブラウザのHTTPリクエストの違い
- 送受信時にHTMLの画面がフラッシュ（リロード）されない
  - Ajax(Asynchronous JavaScript + XMLの略)
- メソッドとして、GETとPOST以外も送信できる
- フォームの場合、キーと値が1:1になっている形式のデータしか送信できず、レスポンスはブラウザで表示されてしまうが（XMLという名前に反して）、プレーンテキスト、JSON、バイナリデータ、XMLなど、さまざまなフォーマットが送受信できる 
- いくつか、セキュリティのための制約がある
  - 5.3.4 で説明

### 5.3.3 Comet
- XMLHttpRequest を駆使してほぼリアルタイムの双方向通信を行うテクニック
![pooling_types](https://user-images.githubusercontent.com/42827865/182977816-4750a753-f955-46c1-8363-132a58a088e9.png)
- ポーリング
  - 通知を受ける側が、頻繁に通知がないか聞きに行く方式
- ロングポーリング
  - クライアントからのリクエストを受け取ったサーバーが即時にレスポンスを返すのではなく自由なタイミングで返すことで、サーバーからリクエストを送っているように見せかける
  - リバースAjaxと呼ばれることも
  - Cometはこちら
  - 欠点
    - 通常のHTTP通信のため、クッキー、ヘッダーを含んだ大きなオーバーヘッド
    - 一度サーバーからレスポンスを返すとクライアントからセッションを張り直さないと通信ができないため、サーバーからの連続したメッセージ送信には強くない

### 5.3.4 XMLHttpRequestのセキュリティ
- Webページに悪意のあるスクリプトが埋め込まれるとデータ改変、データ漏洩等が発生し得る
- XMLHttpRequestのセキュリティ制御は、アクセスできる情報の制限、送信制限という2つの制限から成り立っている
  - アクセスできる情報の制限
    - cookie
       - httponly属性をクッキーに付与するとスクリプトからアクセスできなくなる
  - 送信制限
    1. ドメイン
       - 同一生成元ポリシー（Same Origin Policy）による、「リクエストを送信できるドメインの制限
    2. メソッド
       - CONNECT、TRACE、TRACK（IIS用のTRACEの別名） を指定すると、open()メソッドの呼び出し時にSecurityError例外が送られる
    3. ヘッダー
       - 以下のものが禁止されている
         - プロトコルのルールや環境に影響を与えるもの
         - クッキーなどのセキュリティに影響を与えるようなもの
         - ブラウザの能力を超えられないもの(e.g., ブラウザ自身が対応していない圧縮フォーマットをAccept-Encodingに指定する 等)

## 5.4 Geo-Location
- クライアントの物理的な場所を扱う
- クライアントが測定する方法とサーバー側で推測する方法がある

### 5.4.1 クライアントが場所を得る方法
- Geolocation API
  - スマートフォンであればGPSや基地局の情報を使って位置情報を得る
  - GPSの付いていないパソコンでもWifiなどによる位置測定によって大まかな位置を推測する
    - WifiのアクセスポイントのユニークなID(BSSID)と緯度・経度のデータベースを事前に構築しておき、アクセスできるアクセスポイントのBSSIDからサーバーに問い合わせる
    - Wifiのアクセスポイントによる位置推定を最初に事業化したのはSkyhook wireless
      - Skyhook wireless はくまなく車を走らせて位置情報を収集していった
      - その後、スマートフォンを使った自動収集が行われるようになった
  - 位置情報はプライバシーに直結するためユーザーによる仕様許可が必要。また、スマートフォンによるアクセスポイントの自動収集もシビアな仕組みになっている

### 5.4.2 サーバーがクライアントの場所を推測する方法
- GeoIP
  - IPアドレスから推測する方法
  - IPアドレスは地域ごとにレジストリの管理団体があるが、正確な場所までは管理していない
  - Geolocation同様、地道に収集したデータを元に位置情報を返すサービスがある
    - MaxMind
    - ip2location
    - ipligence
    - どこどこJP
  - GPSに比べると誤差は大きいがサービス側は勝手に取得できる利点があり、逆にクライアントはプロキシ等で隠すしかない
  - ターゲティング等のマーケティングへの利用や地域ごとのサービスの出し分け、いつもと違うエリアからの不正アクセスの検知等で利用されている

## 5.5 X-Powered-Byヘッダー
- RFCの規格外の独自ヘッダーだが、多くのサーバーがシステム名を返すのに使用しておりデファクトスタンダード化していた
- メリット
  - クライアント側がサーバーの種類によって処理を切り替えられる
- デメリット
  - レスポンスサイズが増える
  - サーバーの特定のセキュリティホールを突かれる可能性がある
- 現在は [RFC1945](https://tools.ietf.org/html/rfc1945.html) で標準化されている Server ヘッダーが利用されるようになっている
- 元々はパイプライニング等、後方互換性の低い新機能が利用できるかの検証のために必要であった
- 現在は相互接続性の確認や堅牢な規格の策定が重要視されているため、今後はServerヘッダーによる検証の必要性も低いと考えられている
- 類似のヘッダーにviaヘッダーがあり、どの名前のどのバージョンのプロキシサーバーが通信内容をどのように解釈したか等の情報が付与される
  - 現代ではTLSが標準になり途中でコンテンツを書き換えるということは無いのでviaヘッダーももう必要はないと考えられる

## 5.6 リモートプロシージャコール(RPC)
- プロシージャとは「一覧の処理が羅列された処理の塊」
- 別のコンピュータにある機能を、あたかも自分のコンピュータ内であるかのように呼び出しを行い、必要に応じて返り値を受け取る仕組み
- リモートメソッド呼び出し（RMI:Remote Method Invocation）と呼ばれることも

### 5.6.1 XML-RPC
- UserLand SoftwareとMicrosoftによって1998年に開発
- 規格は [xmlrpc.scripting.com](http://xmlrpc.scripting.com/spec.html) にある
- 仕様
  - Content-Lengthが明示されている必要がある
    - HTTP/1.1のチャンク形式はサポートしていない
  - 送信に使うメソッドはPOST
    - GETはキャッシュされてしまう可能性があるため、RPC通信には向かない
  - 呼び出しの引数、返り値ともにXMLで表現するのでContent-Typeは常にtext/xml
  - XML-RPCを公開しているサーバーは、多少のエラーがあってもステータスには基本的に200 OKを返すことになって

### 5.6.2 SOAP
- SOAPはXML-RPCを拡張して作られた規格
  - W3Cで規格化されている
- 構造
  - HTTPの中にミニHTTPのような構造を持っている
    - HTTP以外にもメール送信プロトコル（SMTP）を使ってSOAPメッセージをやりとりすることも可能
  - ヘッダーにはリクエストのメソッドやトランザクション情報を記述し、エンベロープにはデータが入る

![soap](https://user-images.githubusercontent.com/42827865/182977884-f4b6b4e0-9607-4bdd-8f01-2a6a8f6da0b4.png)

  - SMTP対応など、可搬性を重視するあまり、HTTPの上に同じような機能性のレイヤーを設けてしまったことも複雑度を増している
  - SOAPの仕様策定はエンタープライズ志向の会社が関わっていたこともあり、スキーマなどを完全装備する方向性で定義されている
  - SOAPと強く関連する仕様であるWSDL(ウェブサービス定義言語)を使うことでHTTPのインタフェース自体の定義を記述できるようになる
  - 複雑で膨大なXMLと格闘する必要があり、単純なRPCを実行したいだけでもかなり大変であった

### 5.6.3 JSON-RPC
- XML-RPCのXMLの代わりにJSONを使ったリモートプロシージャコール
- SOAPとは対照的にシンプルに、という方針が全面に押し出されている
- [http://www.jsonrpc.org/](http://www.jsonrpc.org/) という独自のサイトに仕様が掲載してある
- HTTP以外のTCP/IPソケットなどを使うことも想定してある
- 仕様
  - リクエスト時に必要なものは、Content-Type、Content-Length、Accept
  - 基本的にはPOSTを使うのが望ましいが、べき等で安全なメソッドを呼び出すときにはGETも使用可能
  - バージョン指定のために"jsonrpc": "2.0"が必要
  - id はリクエストとレスポンスを対応付けるためのIDで、数値や文字列が使える
  - method にはメソッド名を文字列で指定
  - params には引数を記述。配列でもオブジェクトでも使え、省略も可能
  - 返り値は入力に使用したidと、値そのものがresultに格納される
  - error にはエラー時の情報が格納される
  - id を省略するとサーバーからレスポンスを返さない *Notification* というモードになる
  - XML-RPCは常にステータスが *200 OK* だったが、JSON-RPC ではこれ以外にもいくつかステータスを定めている
    - 200 OK
      - 正常終了
    - 204 No Response / 202 Accepted
      - Notification 時の返り値
    - 307 Temporary Redirect / 308 Permanent Redirect
      - リダイレクト（自動再送はしない）
    - 405 Method Not Allowed
      - GETメソッドがサポートされていない安全ではないメソッドにGETメソッドを利用した
    - 415 Unsupported Media Type
      - Content-Typeがapplication/jsonではない
  - BatchモードでリクエストのJSONオブジェクトを複数まとめて配列に入れて一度のHTTPリクエストで複数のプロシージャ呼び出しが可能

## 5.7 WebDAV
- HTTPを拡張することで分散ファイルシステムとして使えるようにしたもの 
- 定義
  - [RFC2518](https://tools.ietf.org/html/rfc2518.html)
    - Microsoftが開発し1999年に策定
  - [RFC4918](https://tools.ietf.org/html/rfc4918.html)
    - 現在はこれに更新されている
  - 以下も追加で関連RFCとして定義されている
    - [RFC3253](https://tools.ietf.org/html/rfc3253.html)
      - バージョン管理
    - [RFC3744](https://tools.ietf.org/html/rfc3744.html)
      - アクセス制御 
- 使用するだけであればOS標準のファイルマネージャー等から簡単に接続できる
  - Windows Explorer
  - macOS Finder
  - Linux系OS Nautilus, Konqueror
- WebDAVをさらに拡張して、カレンダーやToDoの同期に使うためのCalDAVも[RFC4791](https://tools.ietf.org/html/rfc4791.html)で策定されている
- 用語
  - リソース
    - ファイルのこと(HTTPの用語をそのまま引き継いでいる)
  - コレクション
    - フォルダ、ディレクトリのこと
  - プロパティ
    - リソースやコレクションの追加情報。作成日時、更新日時、最終更新者等
  - ロック
    - 分散ファイルシステムは複数人で同時にファイルを編集すると後勝ちになってしまうので、これを避けるための仕組み
- 基本的にはHTTP/1.1の作成（POST）、読み込み（GET）、更新（PUT）、削除（DELETE）の各メソッドをそのまま利用するが、ファイルシステムとしては機能が足りないのでメソッドが追加されている
  - COPY, MOVE
    - ローカルにGETしてサーバーにPOSTし直すのは非効率なのでサーバー側だけで完結できるように
  - MKCOL
    - コレクション(フォルダ、ディレクトリ)の作成
  - PROPFIND
    - コレクション内の要素一覧の取得
  - LOCK/UNLOCK
    - ファイルのロック制御
- 現在使われているオンラインストレージサービスとの違いは同期型を前提としている点
  - WebDAVは基本的に常にネットワークとの接続が必要だが、オンラインストレージはローカルにコピーを持ち必要に応じて同期を取る
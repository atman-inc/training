# 14章 セキュリティ:ブラウザを守るHTTP機能

@m.sasaki

## 14.1 従来型の攻撃

- 従来というのはブラウザを狙った攻撃以外という意味で筆者が呼んでいて、一般的な分類ではないことに注意
  - 従来型はブラウザの外のOSにアクセスするのが特徴

### マルウェア

- コンピュータに脅威を与える悪意を持ったソフトウェアの総称

<br>

- 種類
  - コンピュータウィルス
    - 経済産業省のコンピュータウイルス対策基準の定義では以下機能の1つ以上を有するもの
      - 自己伝染機能
        - 自らの機能によって他のプログラムに自らをコピーし又はシステム機能を利用して自らを他のシステムにコピーすることにより、 他のシステムに伝染する機能
      - 潜伏機能
        - 発病するための特定時刻、一定時間、処理回数等の条件を記憶させて、発病するまで症状を出さない機能
      - 発病機能
        - プログラム、データ等のファイルの破壊を行ったり、設計者の意図しない動作をする等の機能
    - 参考: [経済産業省](https://www.meti.go.jp/policy/netsecurity/CvirusCMG.htm?types-of-computer-viruses)
    - 参考: [Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%82%A6%E3%82%A4%E3%83%AB%E3%82%B9)
  - ワーム
    - ネットワーク機器やOSのセキュリティホールを攻撃して感染を広げる
    - 自らが実行形式のプログラム
    - メールだけでなく、同じネットワークに繋がれたデバイスを自動的に検出して感染させたり、社内や組織内のサーバーにある共有フォルダやUSBメモリから感染したりと、感染する速度が非常に早いのが特徴
    - ウィルスとの違いは他のシステムへの感染にファイルを必要としない点
      - 参考: [ワームウィルスとは？](https://solution.fielding.co.jp/service/security/measures/column/column-15/)
      - 参考: [Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%AF%E3%83%BC%E3%83%A0_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF))
  - キーロガー
    - キー操作を記憶する。記録したキー操作からパスワードなどを盗む
      - 参考: [キーロガーとは？](https://news.mynavi.jp/siryou_hikaku/20210108-1625825/)
      - 参考: [Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%AD%E3%83%BC%E3%83%AD%E3%82%AC%E3%83%BC)
  - トロイの木馬
    - 外部から遠隔操作を行わせるためのバックドアを設ける
    - 他のファイルやプログラムに依存せず、自己増殖しないタイプ
    - スマホ、タブレット、パソコンに潜みネット銀行やネットショッピングを利用するタイミングでログイン情報を盗んだり、デバイス内の個人情報を盗み見る
    - 感染経路も様々で感染しやすい
    - ウィルスとの違いは他から感染して発病するのではなくトロイの木馬自体が悪意のある動作をする点
      - 参考: [トロイの木馬とは？](https://www.amiya.co.jp/column/trojan_20210113.html)
      - 参考: [Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%AD%E3%82%A4%E3%81%AE%E6%9C%A8%E9%A6%AC_(%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2))
  - ランサムウェア
    - 感染したコンピュータは利用者のシステムのアクセスを制限する
    - 制限解除のために身代金の請求などが行われる
    - 企業や組織に大きく影響を及ぼしたセキュリティ脅威の第1位
    - 典型的にはトロイの木馬として増殖する
      - 参考: [ランサムウェアの被害事例](https://insights-jp.arcserve.com/ransomware-cases)
      - 参考: [Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%B3%E3%82%B5%E3%83%A0%E3%82%A6%E3%82%A7%E3%82%A2)

> ※ 注意
> 攻撃手法が徐々に認知されて命名されたため名前や定義は異なる場合がある
> 従来型だからといってもWebサービス開発者にとってサービスを守る上で脅威であることに変わりはない

---

## 14.2 ブラウザを狙う攻撃の特徴

- ブラウザは本来「閲覧用アプリケーション」だが、他のサービスに繋がった「窓」
  - ブラウザが保存する様々なWebサイトへのログイン情報が盗まれると？
    - LINE等の外部サービスに保存されている個人情報が盗まれる
    - ネット通販やネットバンキングで金銭的な被害に遭う
    - トロイの木馬によるDDoS攻撃に悪用される

<br>

- 「ブラウザを狙う」といっても、ブラウザの脆弱性を狙うだけでなくHTMLやJavaScriptの脆弱性も標的になる
  - Webサービスでは開発者が理解すべき仕様の複雑度が増している
    - 近年発展が著しいフロントエンド技術
    - 複数サイトを横断したアカウント連携
    - HTTPS/HTTPの混在
  - 個々のセキュリティ機能が強力でも、Webサービスの実装上のミスや勘違いなどからセキュリティの穴ができる
    - そのセキュリティの穴が狙われる
    - 正規のWebサイトからHTTP転送されてきたドキュメントの中に罠が仕掛けられることもある
      - この時システム設定の書き換えの痕跡が残らないため、通信ログを見て不審なサイトへのアクセスが無いか確認する等のセキュリティ対策が必要
  - この章ではよく知られる攻撃手法と、それに対抗するためのHTTPの仕様を紹介する

---

## 14.2.1 セッショントークン or クッキー

- ブラウザが認証されてユーザ固有のコンテンツへの通行手形として利用される鍵の名前
  - 多少のニュアンスは異なるが大体同じような意味で使われる

<br>

- 種類
  1. セッショントークン
  2. セッションクッキー
  3. セッションキー
  4. セッションID
  5. アクセストークン
- ブラウザ以外も対象とするものではアクセストークンと用語が決まっているものもある

<br>

- 本章では以下用語と意味として説明する
  - セッショントークン
    - 意味: クッキーに格納されるユニークなIDデータ（文字列）
  - クッキー
    - 意味: セッショントークンの入れ物

<br>

- このクッキーやセッショントークンが奪われると「ログイン済み」として扱われ防御の機構が一気に剥がされる
  - セキュリティの要と言える

---

## 14.3 クロスサイトスクリプティング（XSS）

- クロスサイトスクリプティングとは
  - 多くの攻撃の起点となる攻撃方法
  - Webサービス開発者が真っ先に気をつける攻撃

<br>

- 発生しやすいシナリオ
  - 掲示板などのユーザ入力コンテンツで、ユーザが入力した内容をフィルタリングせずに公開する

<br>

- 攻撃方法
  - 入力値の検証をせずにHTMLの中にそのまま書き込んで出力している場合、悪意を持ったスクリプトが埋め込まれるとブラウザ上でスクリプトが実行される
    - 例: `<script>alert("Hellow world")</script>`と内容が書き込まれるとアラートダイアログが表示される

<br>

- 他のすべての攻撃の起点になりうるため、これから紹介する攻撃の中で最も危険な攻撃と言える
  - 例えば
    - 投入されたスクリプトからクッキーにアクセスされ、別サーバに転送 → クッキー情報が漏洩する
    - ログイン済みのセッショントークンが盗まれるとログイン情報が無くても「ログイン状態」が横取りできる
    - ログインフォームがハックされユーザーが入力した情報を別サーバに送信される
    - フィッシングサイトに転送される

<br>

- 防御方法
  - ユーザが入力したコンテンツは悪意を持った入力が来るものとみなし、そのまま出力しないようにする
    - サニタイズ
      - 入力時点で特別な意味を持つ記号を無毒化する
    - エスケープ
      - サニタイジングの一種だがより具体的な処理を指す
      - 特別な意味を持つ記号を、その記号とは別の表現に変える事
        - 例: `<` = `&lt;`、`>` = `&gt;`
  - 出力の種類
    - HTMLとして出力
    - 外部プロセス実行時の引数
      - コマンドインジェクションと呼ばれる
    - データベースで実行するSQLとして出力
      - SQLインジェクションと呼ばれる

<br>

- 出力先によって必要なエスケープ処理は変わるが、テンプレートエンジンやプレースホルダーの多くが安全な出力を保証してくれる
  - → 適切なライブラリを使用することで開発者のミスを減らすことができる

---

## 14.3.1 漏洩を防ぐためのクッキーの設定

- XSSの次の防衛線
  - 2章のクッキーの説明で紹介した「httpOnly属性」を付与する方法:[参照](chapter_2.md)
  - httpOnly属性を付与するとJavaScriptからアクセスできないクッキーになる
  - XSSの攻撃者はJavaScriptを使用するため、JavaScriptからアクセスできない情報には触れることができない
    - → JavaScriptによるセッショントークン漏洩の危険を減らせる
# 13章　クラウド時代のHTTP: ウェブを強くする様々な技術

@nikuteresa

## 13.3 リバースプロキシ

- 前提として、ローカルネットワーク(クライアント)から外のネットワークに行く途中にいるものがプロキシと呼ばれている。
- リバースプロキシは外の世界からリクエストが来たときに、そのリクエストを最初に受け取りサーバーに中継するもののこと(サーバー側にあるプロキシ)
- クライアント側から DNS(サーバー) にリクエストをした際、それがリバースプロキシであるかは判断ができない
- サーバーより先にリクエストを受けるサーバーをリバースプロキシと呼んでいるだけで、リバースプロキシで何を行うかは用途により色々ある

質問したいこと
- クライアントから受けたリクエストを返せるのは、リクエストを最初に受け取ったサーバだけ？(リバースプロキシを無視してクライアントにレスポンスを返す)

- リバースプロキシの使用例
    - cdn(コンテンツデリバリーネットワーク)
        - キャッシュデータをクライアントと近い位置から返すことで通信距離を短縮
    - ロードバランサー
        - アクセスするサーバーを振り分けて負荷分散
    - 認証機能
        - サーバーにアクセスする前に 認証(basic認証や open id connect)を行いセキュリティの向上
    - 圧縮
        - データコンテンツを圧縮してクライアントに返却することで、通信データを小さくする
    - ログ
        - 複数サーバーがある場合に一括でログを管理したり
    - 静的コンテンツの配信をしつつ動的コンテンツは別サーバにリクエスト
    - TLSでリクエストを受け取り、複合化したHTTPをサーバーにリクエスト(負荷分散?)
    - JavaScript, CSS をビルドしつつサーバーAPIのリクエストを後ろのサーバーに投げる(サーバーサイドレンダリング?)

- 技術的にみるとリバースプロキシはHTTPのウェブアプリケーションと変わりませんが、リバースプロキシ単体で機能を完結するわけではなくサーバーを補助するような役割をしている

- リバースプロキシのサンプルとして APIゲートウェイの kong や、Kubernetes上で使われるロードバランサーの Ingress などがある

## 13.3.1 Go言語によるリバースプロキシの実装
スキップ

## 13.4 CDN(Content Delivery Network)
- CDNの認知度が上がったが、インフラレイヤーに関わる人以外から見ると「早いキャッシュ」「ウェブサーバーの負荷を減らすもの」という認識だった、現在ではその他にも高速なWebサービスを作るための機能を備える様になった
- ネットワーク同士の接続を補助し、ネットの高速化や安定性の向上
- プロバイダーの視点でみると、上流のネットワークに払うコストの削減などのメリット

### 13.4.1 通信そのものを高速化＆安定化
- DNSを使った仕組みを通じてCDNの提供するドメインを参照し、ユーザーの利用場所に近い場所のホストのIPアドレスを返す。
- PCやスマホはインターネットプロバイダに属することで、インターネットにアクセスできるようになる、この仕組みを AS(Autonomous System) という
- AS同士が連結されているのがインターネットで、 Tier1, Tier2, Tier3 と階層構造に繋がったネットワークになっている
- Tier1 は世界で数えるほどしかなく、日本では NTT Communications が Tier1
- AS 同士は木構造のように 各Tier を辿ってアクセスを行うが、CDN を使うことでショートカットできる

### 13.4.2 ユーザーに近い高機能なプロキシサーバー

#### ユーザーに近い場所でのコンテンツ配信
- CDNの各企業は競い合ってプロキシサーバーに様々な機能を追加している
- ユーザーに近いところに CDN を置くことでオリジンサーバーの負荷、ネットワーク帯域は小さくて済む
- 動画コンテンツ配信に CDN は大きな効果を発揮する
- 動画サービスを運用している Netflix Google は コンテンツ配信業者であり、 CDN 事業者でもある
- スマホゲームの配信にも CDN が使われている場合が多く、予想を上回る CDN への支払いが発生することがある

#### 高機能なプロキシサーバー
- DDos攻撃をされた際に、アクセスを分散しオリジンサーバーが操作不能になる可能性を下げる
- 不正アクセスのパターンを検知して、アクセスを止める (WAF)
- URLのパターンで後段の呼び出しを変更
- IPアドレスでアクセス制限
- JavaScriptなどの言語をつかってレスポンスをカスタマイズ
- CDN 上で動的コンテンツを生成するエッジサイドインクルード(ESI)

#### Cache-Control(2)
- リクエストヘッダーに Cache-Control を含めることで CDN への指示となる命令がある
- サーバー側から CDN へのレスポンスでも指示ができる
- リクエスト
    - no-chache
        - CDNがキャッシュしていても、それを無視してオリジンへリクエストして欲しいと要請
    - no-store
        - CDNにキャッシュを削除するように要請
    - max-age
        - プロキシで保存されたキャッシュが最初に保存してから指定時間以上のキャッシュは使用しないように要請
    - max-stale
        - 鮮度維持期間がすぎても、クライアントはそれを受け取ることをプロキシに要請
    - min-fresh
        - 鮮度維持期間が指定された以上残っていれば、キャッシュを送信しても良いとプロキシに要請
    - no-transform
        - プロキシがコンテンツを改変するのを抑制するようにプロキシに要請
    - only-if-cached
        - キャッシュしている場合のみ応答を返し、そうでなければ 504 Gateway Timeout を送信することをプロキシに要請する。初回を除いてオリジンサーバーへのアクセスは行われない
- レスポンス
    - s-maxage=n
        - max-ageと同様、確認せずにキャッシュを利用できる期間を指示する。共有のキャッシュに対する設定値で max-age よりも優先される
    - no-transform
        - プロキシがコンテンツを改変するのを抑制
    - must-revalidate
        - プロキシサーバーがサーバーに問い合わせたときに、サーバーの応答がなければプロキシサーバーがクライアントに 504 Gateway Timeout を返す
    - proxy-revalidate
        - must-revalidate と同様だが、共有のキャッシュのみに対する要請

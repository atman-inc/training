## 1.4 何がテスト・スイートの質をよくするのか？

* 信頼できる評価方法
	* 結論（極論）として、全てのテストケースを1つずつ評価

* 現実的には難しい
	* 何がテスト・スイートの質を全体的によくするのか
		* 優れたテスト・スイートの特徴
			1. テストが開発サイクルに組み込まれている
			2. 特に重要なコード、ロジック`のみ`がテスト対象となっている
			:::note info
			※のみが「自動化テスト対象」となっている、と理解するとしっくりくる
			:::

			3. 最小限の保守コストで最大限の価値を生み出すようになっている

### 1.4.1

* 自動化テストは、そのテストが常に実施される場合のみ導入する意味がある
	* 理想は軽微な変更であっても、テストが実施されること

### 1.4.2

* 単体テストのコスト（労力）
	* システムの重要な部分にコストをかける
	* そこまで重要ではない部分は簡易な検証

* 核となる部分はビジネスモデルを含む部分＝`ドメインモデル`となる
	* 故にビジネスモデルに対するテスト＝コストの価値として最も効果的
:::note info
ドメインモデル：システムに関わるさまざまな実体とそれらの関係を説明するシステムの概念モデル
:::

* ドメインモデルではないコード
	* インフラに対するコード
	* 外部サービスや依存関係にあるもの
		*※利用したライブラリ等もこれに含まれる

	* 構成要素同士を結びつけるコード

	:::note info
	ここで言う「構成要素」とはブロック（塊）と解釈すればいい？
　　(コードのブロック＝関数やクラス等の部品)
	:::

* これらを単体テストすること自体に問題はないが、通常は単体テストにおいて意識すべきはドメインモデルである

### 1.4.3

* 上述の内容に加え、テストケースを保守コストより高い価値のものだけにすることも必要
	* 実現するには、以下を行えなくてはならない
		* 価値のあるテストケースを認識できる（質の善し悪しを判断できる）
		* 価値のあるテストケースを作成できる（「認識」できた上で、更に設計、コード内容の理解も必要）

### 1.5 本書で学べること
* テストケースを分析する際の基準となる枠組みについて
* 枠組みを用いたテストケースの分析
* 単体テストのテクニック、プラクティスの分析

***

# 第2章　単体テストとは何か

## 2.1 単体テストの定義

* 様々な定義があるが、以下の重要な性質を全て備えるもの
	* 自動化されている
	* 単体（UNIT)単位での動作の検証
	* 実行時間が短い
	* `隔離`された状態で実行

* 「隔離」に対する考え方の違いから、古典学派とロンドン学派に分かれた

:::note info
※名前の由来
　古典学派　　：元来の取り組みを採用していることから
　ロンドン学派：ロンドンのコミュニティから生まれたことから
:::

### 2.1.1 ロンドン学派が考える隔離

* テスト対象クラスが依存しているクラスを全てテストダブルに置き換える

※テストダブルとはドライバ、スタブのこと？→なんか違うらしい

<dl>
<dt>メリット</dt><dd>テスト失敗時、依存部分は対象から除外できる</dd>
<dt></dt><dd>オブジェクトグラフを分離してテストできる</dd>
</dl>

:::note info
オブジェクトグラフ：オブジェクトグループが別のオブジェクトへの直接参照等を通じて、相互ネットワークを形成したもの
:::

* 依存から隔離することで得られる副次的効果
	* 1つのクラスは1つのテストケース、というシンプルな構造になる

* 具体例：ECサイトのアプリ

	* ユースケースは「顧客が商品を買う」
	* 在庫数が充分ある場合は売って（取引成立）、在庫を減らす
	* 在庫数が足りない場合は売れないので（取引不成立）在庫も減らさない
<BR>
	* 依存クラス：Store
	* テスト対象：Customer

* 古典学派スタイルの単体テスト
	* CustomerとStoreが隔離されていない（2つのクラスをテストしてることになる）

* ロンドン学派スタイルの単体テスト（モック使用）
:::note info
※モックとスタブの違いは別の章で説明してくれるとのこと
:::

	* StoreクラスはMOQ（モックのフレームワーク）でクラスを生成

	* 検証方法の違い

		* 古典学派スタイル：Storeオブジェクトの在庫数にて検証
		* ロンドン学派スタイル：MOQの機能（Verify）にてCustomerからStoreの在庫数を減らすメソッドが呼ばれた回数で検証

##  2.1.2 古典学派が考える隔離

* 単体テストの性質の1つ：単体（Unit)と呼ばれる、少量のコードを検証する

	* Unitの解釈についても相違がある

		* ロンドン学派：通常、一度に1つのクラスしかテストしない
		* 古典学派：隔離するのはコードではなく、テストケースである
			* テストケースが隔離できる単位でのテスト
			* 共有依存でない限り、複数のクラスを1Unitと解釈
　　
* 依存には共有依存、プライベート依存、プロセス外依存がある

	* 共有依存：テストケース間で共有される依存
		* 共有依存を含む複数のテストケースが同時実行された場合問題となる（DB、ファイルシステムなど）
		:::note info
		※クラス間での共有ではない点に注意
		:::

		* Storeクラス自体はECシステムの複数箇所で使用している（と思われる）
			* インスタンス生成により、単体テストでのテストケース間の共有は発生しない
			* この場合はStoreはプライベート依存である

		* 設定を行うクラス等も、通常はシステム内で1インスタンスで共有される
			* テストケース内でインスタンス生成すれば、単体テスト上はプライベート依存

	* プライベート依存：共有されない依存

	* プロセス外依存：別プロセスで稼働する依存（DB、API等もそう）
		* プロセス外依存＝共有依存のケースが多い
			* DockerでDB動かせば共有依存にはならない
:::note info
※本当にそうかな？ それだとテストケース1つにつき
Docker1つ用意しなきゃそうともいえない気がする。
複数のテスター間は隔離できるが、1人のテスターが複数のテストケースを
実行する場合、Dockerの準備って1つだけにしません？
:::

			* 読み込み専用のDB（更新権限のないロールでのアクセスという意味だと思われる）
				* こちらは共有依存ではない

:::note info
※揮発性依存について
　→混乱するんでこのコラムは無視します
:::

* 共有依存をテストダブルに置き換える、もう1つの理由：テストの実行速度の向上

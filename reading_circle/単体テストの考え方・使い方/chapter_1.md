# 第1章 なぜ、単体(unit)テストを行うのか？

@dameleon

- コスパの良い単体テスト実装を目指す
  - コスパが良い
    - 保守性、拡張性がある状態の担保
  - コスパが悪い
    - バグ、保守性に難がある状態

## 1.1 単体テストの現状

- 多くの開発者が、"単体テスト"を行うことは当然であり、重要であるという意識を持つようになってきた
  - 個人メモ: 以下理由もあると思ってる
    - クライアントアプリケーションがリッチになったこと
    - APIによる祖結合なアプリケーションの分離
      - マイクロサービス
- 統合テストを含め、テストコードがアプリケーション実装を網羅している範囲をカバー出来るように努める
  - 単純な行数で測るのは難しいが、`実装 1:3-10 テストコード`みたいなイメージ
- 単体テストを書くべき？良い単体テストとは？ということに議論が向いてきた
- 苦労に見合ったコスパの高いテストを目指すための科学的な定義を学んでいく

## 1.2 なぜ、単体テストを行うのか？

- 設計を洗礼するために単体テストのプラクティスを実践する
  - ただし、これは副産物
  - 単体テストがしづらい = 多くの場合で密結合が起きている
  - 単体テストがしやすい != 設計, コードの質が高い
- 単体テストは "持続可能" を目指すこと
  - テストなしの状態では、指数的に実装コストがかかっていく
- ソフトウェアエントロピー
  - コードベースに対する変更は、コードに対するエントロピーを増加させること
    - 無秩序が積み重なると、ドミノ倒しのようになる
    - 無秩序の結果、安定した状態にもどすことも難しくなる
  - テストがある状態では、エントロピーの制御が出来る
    - 退行の検知
    - リファクタリングの容易性
- テストコードを書く労力は短期的にはメリットが見えづらい
  - 成長性を止めないためのコストをかける

### 1.2.1 何がテストの質を良くし、何がテストの質を悪くするのか？

- 質の悪い単体テストは、テストを全くしない場合と同じような結果になる
- 全てのテストケースは平等に作られているわけではない
  - 価値のあるテスト、価値のないテスト、どちらもある
  - 単に"単体テストを行った"という事実を作り上げることだけを目的としない
- 単体テストの目標を実現させるには、以下を考慮する
  - 作成する単体テストの価値
  - その維持にかかるコスト
- コストとなる要因
  - リファクタリングによるテストコードのリファクタリング
  - コード変更するたびにテストを実施する
  - テストが失敗したときの対処
  - コードに対する振る舞いを理解するためのコードリーディング

## 1.3 網羅率(coverage)とテスト・スイートの質と関係

- 網羅率(coverage): テストスイートに含まれるテストケースが実行するプロダクションコードの割合
- 網羅率が高いほど良いテストであるか？
  - 網羅率が高い != テストスイートの質が良い
- 個人メモ: カバレッジが納品時の非機能要件に含まれるケースもある

### 1.3.1 コード網羅率(code coverage)について

- コード網羅率 = (実行されたコードの行数 / 総行数)
- 単純に"総行数"に対する実行されたコードの"行数"となるため、仮に三項演算などを行うとカバレッジは100%になる

### 1.3.2 分岐網羅率(branch coverage)について

- 分岐網羅率 = (経由された経路の数 / 分岐経路の総数)
- コード網羅率と違い、テストコードが分岐したコードを通過したかまでを判定して算出する

### 1.3.3 網羅率に関する問題

- 網羅率からは実際にテスト対象のコードが検証されたのかを保証できない
  - 単に実行するだけではなく、"何を確認するのか"をテストコードは示す必要がある
  - "確認不在のテスト"でも、単純に網羅率は上がっていく
- 網羅率を算出する際、使用するライブラリ内のコードは計測の対象から外れる
  - ex. `int.Parse`の取り得る引数全てのケースを担保出来ていないようなケース
  - ライブラリの中のコードも考慮すべきである、ということではない
    - 個人メモ: 例外とかは考慮した方が良いと思われる
- この結果から、網羅率はテストが網羅的に行われている、ということを保障できないことが分かる

### 1.3.4 網羅率の結果に縛られること

- 単純に"網羅率"の数値だけに縛られることは開発の妨げになり得る
  - 本来の"単体テストで達成しようとしている目標から遠ざかる"
  - 数字を達成することばかりに意識が向いてしまう
- 適切な単体テストを行うこと自体が難しいこと
- 網羅率の判断
  - 例えば60%という数字であれば、テストされていないコードが40%残っていることは判別できる
